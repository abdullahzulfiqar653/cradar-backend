name: Deploy to Prod

on:
  push:
    branches:
    - main

jobs:
  deploy-raijin-prod:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: rsync raijin
        uses: burnett01/rsync-deployments@5.1
        with:
          switches: -avzr --delete --exclude="frontend" --exclude="media" --exclude="db" --exclude=".env" --exclude="**/__pycache__" --exclude="credentials"
          path: .
          remote_path: /home/ubuntu/cradar-backend
          remote_host: ${{ vars.IP_ADDR_RAIJIN_PROD }}
          remote_user: ubuntu
          remote_key: ${{ secrets.DEPLOY_KEY_RAIJIN_PROD }}

      - name: running raijin
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.IP_ADDR_RAIJIN_PROD }}
          username: ubuntu
          key: ${{ secrets.DEPLOY_KEY_RAIJIN_PROD }}
          port: 22
          script: |
            cd /home/ubuntu/cradar-backend
            docker image prune -f
            docker builder prune -af
            docker-compose build backend
            docker-compose stop
            docker-compose up -d

      - name: setting crontab to auto restart unhealthy containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.IP_ADDR_RAIJIN_PROD }}
          username: ubuntu
          key: ${{ secrets.DEPLOY_KEY_RAIJIN_PROD }}
          port: 22
          script: |
            echo "* * * * * docker ps -q -f health=unhealthy | xargs --no-run-if-empty docker restart" > /tmp/cronjob.tmp
            crontab /tmp/cronjob.tmp
            rm /tmp/cronjob.tmp
